{"version":3,"sources":["../../src/incentives/index.ts","../../src/incentives/v1.ts"],"sourcesContent":["export * from './v1';\r\n","export type IncentiveDealModeV1 = 'finance';\r\n\r\nexport interface IncentiveEligibilityV1 {\r\n  required: boolean;\r\n  tag: string;\r\n}\r\n\r\nexport interface IncentivePathV1 {\r\n  pathId: string;\r\n  dealMode: 'cash' | 'finance' | 'lease';\r\n  label: string;\r\n}\r\n\r\nexport type IncentiveOfferTypeV1 = 'cash' | 'apr_table' | 'rate_reduction';\r\n\r\nexport interface IncentiveOfferV1 {\r\n  offerId: string;\r\n  pathId: string;\r\n  type: IncentiveOfferTypeV1;\r\n  selectors: {\r\n    trim?: string;\r\n  };\r\n  eligibility: IncentiveEligibilityV1;\r\n  benefit: Record<string, unknown>;\r\n  stacking: {\r\n    group: string;\r\n  };\r\n}\r\n\r\nexport interface IncentiveJsonDataV1 {\r\n  ymmId: string;\r\n  year: number;\r\n  make: string;\r\n  model: string;\r\n  effective: {\r\n    start: string;\r\n    end: string;\r\n  };\r\n  paths: IncentivePathV1[];\r\n  offers: IncentiveOfferV1[];\r\n  programSetId: string;\r\n}\r\n\r\nfunction isRecord(value: unknown): value is Record<string, unknown> {\r\n  return !!value && typeof value === 'object' && !Array.isArray(value);\r\n}\r\n\r\nfunction isIncentiveJsonDataV1(value: unknown): value is IncentiveJsonDataV1 {\r\n  if (!isRecord(value)) return false;\r\n\r\n  return (\r\n    typeof value.ymmId === 'string' &&\r\n    typeof value.year === 'number' &&\r\n    typeof value.make === 'string' &&\r\n    typeof value.model === 'string' &&\r\n    isRecord(value.effective) &&\r\n    typeof value.effective.start === 'string' &&\r\n    typeof value.effective.end === 'string' &&\r\n    Array.isArray(value.paths) &&\r\n    Array.isArray(value.offers) &&\r\n    typeof value.programSetId === 'string'\r\n  );\r\n}\r\n\r\nexport function extractIncentiveJsonDataV1OrThrow(payload: unknown): IncentiveJsonDataV1 {\r\n  const direct = payload;\r\n  if (isIncentiveJsonDataV1(direct)) {\r\n    return direct;\r\n  }\r\n\r\n  if (isRecord(payload) && isIncentiveJsonDataV1(payload.json_data)) {\r\n    return payload.json_data;\r\n  }\r\n\r\n  if (isRecord(payload) && Array.isArray(payload.data) && payload.data.length > 0) {\r\n    const first = payload.data[0];\r\n    if (isRecord(first) && isIncentiveJsonDataV1(first.json_data)) {\r\n      return first.json_data;\r\n    }\r\n  }\r\n\r\n  const hint = isRecord(payload) ? Object.keys(payload).slice(0, 10).join(',') : typeof payload;\r\n  throw new Error(`Unable to extract IncentiveJsonDataV1 from payload (${hint})`);\r\n}\r\n\r\nexport interface EvaluateFinanceIncentivesInputV1 {\r\n  jsonData: IncentiveJsonDataV1;\r\n  trim: string;\r\n  termMonths: number;\r\n  asOfDate: string;\r\n  selectedEligibilityTags?: string[];\r\n}\r\n\r\nexport interface IncentiveCashLineItemV1 {\r\n  offerId: string;\r\n  stackingGroup: string;\r\n  eligibilityTag: string;\r\n  amount: number;\r\n  currency: string;\r\n}\r\n\r\nexport interface IncentiveRateReductionLineItemV1 {\r\n  offerId: string;\r\n  stackingGroup: string;\r\n  eligibilityTag: string;\r\n  aprPoints: number;\r\n}\r\n\r\nexport interface EvaluatedFinanceIncentivesV1 {\r\n  public: {\r\n    aprForTermMonths: number;\r\n    financeCashTotal: number;\r\n    financeCash: IncentiveCashLineItemV1[];\r\n  };\r\n  conditionalAvailable: {\r\n    financeCash: IncentiveCashLineItemV1[];\r\n    rateReductions: IncentiveRateReductionLineItemV1[];\r\n  };\r\n  conditionalApplied: {\r\n    selectedEligibilityTags: string[];\r\n    aprForTermMonths: number;\r\n    financeCashTotal: number;\r\n    financeCash: IncentiveCashLineItemV1[];\r\n    rateReductions: IncentiveRateReductionLineItemV1[];\r\n  };\r\n}\r\n\r\nfunction parseIsoDateOrThrow(value: string, label: string): Date {\r\n  const d = new Date(value);\r\n  if (Number.isNaN(d.getTime())) {\r\n    throw new Error(`Invalid ${label}: ${value}`);\r\n  }\r\n  return d;\r\n}\r\n\r\nfunction groupByStackingGroupOrThrow<T extends { stackingGroup: string }>(\r\n  items: T[],\r\n  label: string\r\n): Map<string, T> {\r\n  const map = new Map<string, T>();\r\n  for (const item of items) {\r\n    const existing = map.get(item.stackingGroup);\r\n    if (existing) {\r\n      throw new Error(`Ambiguous stacking: multiple ${label} items in group '${item.stackingGroup}'`);\r\n    }\r\n    map.set(item.stackingGroup, item);\r\n  }\r\n  return map;\r\n}\r\n\r\nfunction getFinancePathIdOrThrow(paths: IncentivePathV1[]): string {\r\n  const financePaths = paths.filter(p => p.dealMode === 'finance');\r\n  if (financePaths.length !== 1) {\r\n    throw new Error(`Expected exactly 1 finance path, found ${financePaths.length}`);\r\n  }\r\n  return financePaths[0].pathId;\r\n}\r\n\r\nfunction getAprForTermOrThrow(offer: IncentiveOfferV1, termMonths: number): number {\r\n  if (offer.type !== 'apr_table') {\r\n    throw new Error('Expected apr_table offer');\r\n  }\r\n\r\n  const benefit = offer.benefit as { aprByTermMonths?: Record<string, unknown> };\r\n  const table = benefit.aprByTermMonths;\r\n  if (!table || typeof table !== 'object') {\r\n    throw new Error(`APR table missing for offer ${offer.offerId}`);\r\n  }\r\n\r\n  const value = table[String(termMonths)];\r\n  if (typeof value !== 'number') {\r\n    throw new Error(`APR missing for termMonths=${termMonths} on offer ${offer.offerId}`);\r\n  }\r\n\r\n  return value;\r\n}\r\n\r\nfunction normalizeMatchKey(value: string): string {\r\n  return value\r\n    .trim()\r\n    .replace(/\\s+/g, ' ')\r\n    .toLowerCase();\r\n}\r\n\r\nfunction cashLineItemFromOfferOrThrow(offer: IncentiveOfferV1): IncentiveCashLineItemV1 {\r\n  if (offer.type !== 'cash') {\r\n    throw new Error('Expected cash offer');\r\n  }\r\n  const benefit = offer.benefit as { cash?: unknown; currency?: unknown };\r\n  if (typeof benefit.cash !== 'number') {\r\n    throw new Error(`Cash benefit missing/invalid for offer ${offer.offerId}`);\r\n  }\r\n  if (typeof benefit.currency !== 'string') {\r\n    throw new Error(`Cash currency missing/invalid for offer ${offer.offerId}`);\r\n  }\r\n\r\n  return {\r\n    offerId: offer.offerId,\r\n    stackingGroup: offer.stacking.group,\r\n    eligibilityTag: offer.eligibility.tag,\r\n    amount: benefit.cash,\r\n    currency: benefit.currency,\r\n  };\r\n}\r\n\r\nfunction rateReductionFromOfferOrThrow(offer: IncentiveOfferV1): IncentiveRateReductionLineItemV1 {\r\n  if (offer.type !== 'rate_reduction') {\r\n    throw new Error('Expected rate_reduction offer');\r\n  }\r\n  const benefit = offer.benefit as { rateReductionPercent?: unknown };\r\n  if (typeof benefit.rateReductionPercent !== 'number') {\r\n    throw new Error(`rateReductionPercent missing/invalid for offer ${offer.offerId}`);\r\n  }\r\n\r\n  return {\r\n    offerId: offer.offerId,\r\n    stackingGroup: offer.stacking.group,\r\n    eligibilityTag: offer.eligibility.tag,\r\n    aprPoints: benefit.rateReductionPercent,\r\n  };\r\n}\r\n\r\nexport function evaluateFinanceIncentivesV1(input: EvaluateFinanceIncentivesInputV1): EvaluatedFinanceIncentivesV1 {\r\n  const { jsonData, trim, termMonths, asOfDate, selectedEligibilityTags = [] } = input;\r\n\r\n  const asOf = parseIsoDateOrThrow(asOfDate, 'asOfDate');\r\n  const start = parseIsoDateOrThrow(jsonData.effective.start, 'effective.start');\r\n  const end = parseIsoDateOrThrow(jsonData.effective.end, 'effective.end');\r\n\r\n  if (asOf < start || asOf > end) {\r\n    throw new Error(`Incentives not effective for asOfDate=${asOfDate}`);\r\n  }\r\n\r\n  const financePathId = getFinancePathIdOrThrow(jsonData.paths);\r\n\r\n  const trimKey = normalizeMatchKey(trim);\r\n\r\n  const matchingOffers = jsonData.offers.filter(o =>\r\n    o.pathId === financePathId &&\r\n    normalizeMatchKey(o.selectors.trim ?? '') === trimKey\r\n  );\r\n\r\n  const publicOffers = matchingOffers.filter(o => !o.eligibility.required);\r\n  const conditionalOffers = matchingOffers.filter(o => o.eligibility.required);\r\n\r\n  const publicAprOffers = publicOffers.filter(o => o.type === 'apr_table');\r\n  if (publicAprOffers.length !== 1) {\r\n    throw new Error(`Expected exactly 1 public apr_table offer for trim='${trim}', found ${publicAprOffers.length}`);\r\n  }\r\n  const publicAprForTerm = getAprForTermOrThrow(publicAprOffers[0], termMonths);\r\n\r\n  const publicFinanceCash = publicOffers\r\n    .filter(o => o.type === 'cash')\r\n    .map(cashLineItemFromOfferOrThrow);\r\n\r\n  groupByStackingGroupOrThrow(publicFinanceCash, 'public cash');\r\n\r\n  const conditionalCash = conditionalOffers\r\n    .filter(o => o.type === 'cash')\r\n    .map(cashLineItemFromOfferOrThrow);\r\n\r\n  groupByStackingGroupOrThrow(conditionalCash, 'conditional cash');\r\n\r\n  const conditionalRateReductions = conditionalOffers\r\n    .filter(o => o.type === 'rate_reduction')\r\n    .map(rateReductionFromOfferOrThrow);\r\n\r\n  groupByStackingGroupOrThrow(conditionalRateReductions, 'conditional rate reduction');\r\n\r\n  const publicFinanceCashTotal = publicFinanceCash.reduce((sum, item) => sum + item.amount, 0);\r\n\r\n  const selectedSet = new Set(selectedEligibilityTags);\r\n  const appliedConditionalCash = conditionalCash.filter(i => selectedSet.has(i.eligibilityTag));\r\n  const appliedConditionalRateReductions = conditionalRateReductions.filter(i => selectedSet.has(i.eligibilityTag));\r\n\r\n  const appliedConditionalCashTotal = appliedConditionalCash.reduce((sum, item) => sum + item.amount, 0);\r\n  const appliedRateReductionTotal = appliedConditionalRateReductions.reduce((sum, item) => sum + item.aprPoints, 0);\r\n\r\n  const appliedAprForTerm = publicAprForTerm - appliedRateReductionTotal;\r\n  if (appliedAprForTerm < 0) {\r\n    throw new Error(`Computed APR is negative (${appliedAprForTerm}) after reductions`);\r\n  }\r\n\r\n  return {\r\n    public: {\r\n      aprForTermMonths: publicAprForTerm,\r\n      financeCashTotal: publicFinanceCashTotal,\r\n      financeCash: publicFinanceCash,\r\n    },\r\n    conditionalAvailable: {\r\n      financeCash: conditionalCash,\r\n      rateReductions: conditionalRateReductions,\r\n    },\r\n    conditionalApplied: {\r\n      selectedEligibilityTags: [...selectedEligibilityTags],\r\n      aprForTermMonths: appliedAprForTerm,\r\n      financeCashTotal: publicFinanceCashTotal + appliedConditionalCashTotal,\r\n      financeCash: [...publicFinanceCash, ...appliedConditionalCash],\r\n      rateReductions: appliedConditionalRateReductions,\r\n    },\r\n  };\r\n}\r\n"],"mappings":"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","names":[]}